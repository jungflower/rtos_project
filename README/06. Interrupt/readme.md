# 6. ì¸í„°ëŸ½íŠ¸
`ì¸í„°ëŸ½íŠ¸`ëž€?  
- CPUê°€ í”„ë¡œê·¸ëž¨ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” ë„ì¤‘, ê°‘ìž‘ìŠ¤ëŸ½ê²Œ ë°œìƒí•œ ì‚¬ê±´(ì™¸ë¶€ ì‹ í˜¸ ë“±)ì„ ì¦‰ì‹œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ í˜„ìž¬ ì‹¤í–‰ íë¦„ì„ ìž ì‹œ ì¤‘ë‹¨ì‹œí‚¤ê³ , í•´ë‹¹ ì‚¬ê±´ ì²˜ë¦¬ ë£¨í‹´ìœ¼ë¡œ ì œì–´ë¥¼ ë„˜ê¸°ëŠ” ë§¤ì»¤ë‹ˆì¦˜.  

ì¸í„°ëŸ½íŠ¸ ì²˜ë¦¬ë¥¼ ìœ„í•´ì„œëŠ” `ì¸í„°ëŸ½íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬`ë¥¼ ì´ˆê¸°í™”í•˜ê³  ì‚¬ìš©í•˜ëŠ” ì½”ë“œ ìž‘ì„± í•„ìš” -> ì‹¤ì œ ì¸í„°ëŸ½íŠ¸ë¥¼ ë°œìƒì‹œí‚¤ëŠ” í•˜ë“œì›¨ì–´ì™€ ì¸í„°ëŸ½íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì—°ê²°  

ðŸ‘‰ **ARM ê¸°ë°˜ MCUì—ì„œ ì¸í„°ëŸ½íŠ¸ ì²˜ë¦¬ ê³¼ì •**  
`í•˜ë“œì›¨ì–´ â†’ ì¸í„°ëŸ½íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬ â†’ CPU ì˜ˆì™¸ ë°œìƒ â†’ í•¸ë“¤ëŸ¬ ì‹¤í–‰`  

1. í•˜ë“œì›¨ì–´ ì´ë²¤íŠ¸ ë°œìƒ
- í•´ë‹¹ í•˜ë“œì›¨ì–´ëŠ” ì¸í„°ëŸ½íŠ¸ ìš”ì²­ (IRQ ì‹ í˜¸ / FIQ ì‹ í˜¸)ì„ ì¸í„°ëŸ½íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì „ë‹¬  

2. ì¸í„°ëŸ½íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬ 
- ì—¬ëŸ¬ ìž¥ì¹˜ì—ì„œ ì˜¬ë¼ì˜¨ ì¸í„°ëŸ½íŠ¸ë¥¼ ê´€ë¦¬  
- ì„ íƒëœ ì¸í„°ëŸ½íŠ¸ë¥¼ CPU(ì½”ì–´)ì— ì „ë‹¬  

3. CPU (ARM ì½”ì–´)  
- `CPSR` ë ˆì§€ìŠ¤í„°ì˜ I(IRQ Mask), F(FIQ Mask) ë¹„íŠ¸ ìƒíƒœ í™•ì¸  
    - `I=0` -> IRQ  í—ˆìš©
    - `F=0` -> FIQ í—ˆìš©  
- í—ˆìš© ìƒíƒœë¼ë©´ Exception ë°œìƒìœ¼ë¡œ ê°„ì£¼í•˜ê³  PCë¥¼ í•´ë‹¹ Exception vectorë¡œ jump  

4. Exception Vector -> í•¸ë“¤ëŸ¬ ì‹¤í–‰  
- ARMì€ ì¸í„°ëŸ½íŠ¸ ì¢…ë¥˜ë³„ë¡œ ê³ ì •ëœ ì£¼ì†Œ(ì˜ˆì™¸ ë²¡í„° í…Œì´ë¸”)ì„ ê°–ê³  ìžˆìŒ  
- ë²¡í„° ì£¼ì†Œì— ìž‘ì„±ëœ ìµì…‰ì…˜ í•¸ë“¤ëŸ¬ ì½”ë“œë¡œ ì œì–´ê°€ ì´ë™  
ì´ë•Œ CPUëŠ” ì¼ë¶€ ë ˆì§€ìŠ¤í„°(PC, CPSR ë“±)ì„ ìŠ¤íƒì´ë‚˜ ì „ìš© ëª¨ë“œ ë ˆì§€ìŠ¤í„°ì— ì €ìž¥  

5. ì¸í„°ëŸ½íŠ¸ ì„œë¹„ìŠ¤ ë£¨í‹´(ISR, í•¸ë“¤ëŸ¬)  
- íŽŒì›¨ì–´ì—ì„œ ìž‘ì„±í•˜ëŠ” ë¶€ë¶„  
    1. ì»¨í…ìŠ¤íŠ¸ ì €ìž¥(ì¼ë¶€ ë ˆì§€ìŠ¤í„° í‘¸ì‹œ)  
    2. ì¸í„°ëŸ½íŠ¸ ë°œìƒ ì›ì¸ í™•ì¸ (UARTì˜ RT/TX ìƒíƒœ ë ˆì§€ìŠ¤í„° ì½ê¸°)  
    3. í•´ë‹¹ ìž‘ì—… ì²˜ë¦¬ (ë°ì´í„° ì½ê¸°/ì“°ê¸°, í”Œëž˜ê·¸ í´ë¦¬ì–´)  
    4. ì»¨í…ìŠ¤íŠ¸ ë³µì›  
    5. eretë“±ìœ¼ë¡œ ì›ëž˜ ì½”ë“œë¡œ ë³µê·€

6. ì›ëž˜ ì‹¤í–‰ì¤‘ì´ë˜ í”„ë¡œê·¸ëž¨ ë³µê·€  
- ISR ìˆ˜í–‰ ëë‚˜ë©´ ì €ìž¥í•´ë‘ì—ˆë˜ ë ˆì§€ìŠ¤í„° ìƒíƒœ ë³µì›í•˜ê³  ì¤‘ë‹¨í–ˆë˜ ì§€ì ë¶€í„° ì •ìƒ ì‹¤í–‰ì„ ì´ì–´ê°.  

### 6.1 ì¸í„°ëŸ½íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬  
- RealViewPBì—ì„œëŠ” ì¸í„°ëŸ½íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ `GIC(Generic Intterrupt Controller)`ë¼ ë¶€ë¥¸ë‹¤.  

1. GIC ë ˆì§€ìŠ¤í„° êµ¬ì¡°ì²´ ë§Œë“¤ê¸°
```C
// CPU Interface Registers
typedef struct GicCput_t
{
    CpuControl_t       cpucontrol;        //0x000
    PriorityMask_t     prioritymask;      //0x004
    BinaryPoint_t      binarypoint;       //0x008
    InterruptAck_t     interruptack;      //0x00C
    EndOfInterrupt_t   endofinterrupt;    //0x010
    RunningInterrupt_t runninginterrupt;  //0x014
    HighestPendInter_t highestpendinter;  //0x018
} GicCput_t;

// Distributor registers
typedef struct GicDist_t
{
    DistributorCtrl_t   distributorctrl;    //0x000
    ControllerType_t    controllertype;     //0x004
    uint32_t            reserved0[62];      //0x008-0x0FC
    uint32_t            reserved1;          //0x100
    uint32_t            setenable1;         //0x104
    uint32_t            setenable2;         //0x108
    uint32_t            reserved2[29];      //0x10C-0x17C
    uint32_t            reserved3;          //0x180
    uint32_t            clearenable1;       //0x184
    uint32_t            clearenable2;       //0x188
} GicDist_t;

#define GIC_CPU_BASE  0x1E000000  //CPU interface
#define GIC_DIST_BASE 0x1E001000  //distributor

```  
![alt text](image.png)
![alt text](image-1.png)  
- ê° CPU interface / distributor ì£¼ì†Œ memory mapê³¼ ì¼ì¹˜  
- CPU interface (GICC): Distributorê°€ íŠ¹ì • CPUë¡œ ë³´ë‚¸ ì¸í„°ëŸ½íŠ¸ë¥¼ ì‹¤ì œ CPUê°€ ë°›ì•„ ì²˜ë¦¬í•  ìˆ˜ ìžˆë„ë¡ ì—°ê²°  
- ì¸í„°ëŸ½íŠ¸ë¥¼ ë°°ë¶„í•˜ëŠ” ì—­í•   

2. Hal/Regs.cì— GICì˜ ë ˆì§€ìŠ¤í„° ì¸ìŠ¤í„´ìŠ¤ 2ê°œ ìƒì„±  
```C
#include "Interrupt.h"

volatile GicCput_t* GicCpu = (GicCput_t*)GIC_CPU_BASE;
volatile GicDist_t* GicDist = (GicDist_t*)GIC_DIST_BASE;
```

3. Hal/HalInterrupt.h íŒŒì¼ ì¶”ê°€í•˜ì—¬ ì¸í„°ëŸ½íŠ¸ API ì„¤ê³„  
```C
void Hal_interrupt_init(void); // ì´ˆê¸°í™”
void Hal_interrupt_enable(uint32_t interrupt_num); // í™œì„±í™”
void Hal_interrupt_disable(uint32_t interrupt_num); // ë¹„í™œì„±í™”
void Hal_interrupt_register_handler(InterHdlr_fptr handler, uint32_t interrupt_num); // ê°œë³„ ì¸í„°ëŸ½íŠ¸ ë³„ë¡œ ë”°ë¡œ ì—°ê²°í•´ì•¼ í•˜ëŠ” ì¸í„°ëŸ½íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
void Hal_interrupt_run_handler(void); // ê°œë³„ ì¸í„°ëŸ½íŠ¸ì˜ í•¸ë“¤ëŸ¬ë¥¼ IRQ / FIQë¡œ êµ¬ë¶„í•´ì„œ ì¸í„°ëŸ½íŠ¸ í•¸ë“¤ëŸ¬ ì‹¤í–‰
```  

4. Hal/rvpb/Interrupt.c ì„¤ê³„í•œ API ë‚´ìš© êµ¬í˜„  

1. `Hal_interrupt_init()`  
- CPU interface / Distributor ë ˆì§€ìŠ¤í„° ëª¨ë‘ on  
- Interrupt í‚¤ê¸° ìœ„í•´ Priority mask 0xFë¡œ ì„¤ì •  
- Handler í•¨ìˆ˜ ëª¨ë‘ ì´ˆê¸°í™”  

**`enable_irq()` ì¶”ê°€ ë°©ë²•**  
-> cpsrì˜ IRQ ë§ˆìŠ¤í¬ë¥¼ ë„ëŠ” ì½”ë“œ  
1. `/lib/armcpu.h` / `/lib/armcpu.c` ë‚´ìš© ì¶”ê°€
- IRQ / FIQ í‚¤ê³  ë„ëŠ” í•¨ìˆ˜   
- cpsrì„ ì œì–´í•˜ë ¤ë©´ ì–´ì…ˆë¸”ë¦¬ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ë°–ì— ì—†ê¸° ë•Œë¬¸ì— 
    1. ì–´ì…ˆë¸”ë¦¬ì–´ ì†ŒìŠ¤ íŒŒì¼ ë§Œë“¤ì–´ ì™„ì „ížˆ ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ ìž‘ì„±
    2. Cì–¸ì–´ ì†ŒìŠ¤ íŒŒì¼ì„ ë§Œë“¤ê³  Cì–¸ì–´ í•¨ìˆ˜ ì†ì—ì„œ ì¸ë¼ì¸ ì–´ì…ˆë¸”ë¦¬ì–´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²• -> ì´ê±¸ë¡œ ìž‘ì„± ì˜ˆì •  
    ->ìž¥ì : ìŠ¤íƒì— ë ˆì§€ìŠ¤í„°ë¥¼ ë°±ì—… ë° ë³µêµ¬í•˜ëŠ” ì½”ë“œì™€ ë¦¬í„´ ì²˜ë¦¬í•˜ëŠ” ì½”ë“œë¥¼ ì»´íŒŒì¼ëŸ¬ê°€ ìžë™ìœ¼ë¡œ ë§Œë“¬. 
* BICëŠ” 1ì´ ìžˆëŠ” ë¹„íŠ¸ì— 0ì„ ì“°ê³ , ORRì€ ë°˜ëŒ€ë¡œ 1ì„ ì“´ë‹¤. 

**priority mask**  
![alt text](image-2.png)  
- 4ë²ˆë¶€í„° 7ë²ˆ ë¹„íŠ¸ê¹Œì§€ë§Œ ì˜ë¯¸ê°€ ìžˆì–´, ëª¨ë‘ 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ëª¨ë“  ì¸í„°ëŸ½íŠ¸ë¥¼ ë‹¤ ë§ˆìŠ¤í¬í•´ë²„ë¦¼ = ì¦‰ ëª¨ë“  ì¸í„°ëŸ½íŠ¸ë¥¼ ë§‰ìŒ. 
- 4ë²ˆë¶€í„° 7ë²ˆ ë¹„íŠ¸ê¹Œì§€ë¥¼ 0xFë¡œ ì„¤ì •í•˜ë©´ ì¸í„°ëŸ½íŠ¸ì˜ ìš°ì„ ìˆœìœ„ê°€ 0x0ë¶€í„° 0xEê¹Œì§€ì¸ ì¸í„°ëŸ½íŠ¸ë¥¼ í—ˆìš©í•œë‹¤ëŠ” ì˜ë¯¸ -> ìš°ì„ ìˆœìœ„ì˜ ê¸°ë³¸ê°’ì€ 0ì´ë¯€ë¡œ ì‹¤ì œë¡œëŠ” ëª¨ë“  ì¸í„°ëŸ½íŠ¸ë¥¼ ë‹¤ í—ˆìš©  

2. `Hal_interrupt_enable` / `Hal_interrupt_disable`  

![alt text](image-3.png)  

- íŠ¹ì • IRQ IDë¥¼ ë°›ì•„ í•´ë‹¹ ì¸í„°ëŸ½íŠ¸ë¥¼ Enable / disable í•˜ë„ë¡ GIC ë ˆì§€ìŠ¤í„°ì— ë°˜ì˜  
- GICëŠ” ì´ 64ê°œì˜ ì¸í„°ëŸ½íŠ¸ë¥¼ ê´€ë¦¬
    - í•œ ë ˆì§€ìŠ¤í„°(Set Enable)ê°€ 32ê°œì˜ ì¸í„°ëŸ½íŠ¸ë¥¼ ë‹´ë‹¹
    - `SetEnable1` â†’ IRQ32 ~ IRQ63  
    - `SetEnable2` â†’ IRQ64 ~ IRQ95  
- ë”°ë¼ì„œ ì›í•˜ëŠ” ë¹„íŠ¸ ì˜¤í”„ì…‹ì„ êµ¬í•˜ë ¤ë©´ IRQ ë²ˆí˜¸ì—ì„œ 32ë¥¼ ë¹¼ì•¼ í•¨  
- ì´ ê³„ì‚°ì„ ìžë™í™”í•œ ì•Œê³ ë¦¬ì¦˜ì„ Hal_interrupt_enable/disable í•¨ìˆ˜ì— êµ¬í˜„ â†’ ë“œë¼ì´ë²„ëŠ” IRQ ë²ˆí˜¸ë§Œ ì „ë‹¬í•˜ë©´ ì•Œì•„ì„œ ë ˆì§€ìŠ¤í„°/ë¹„íŠ¸ ìœ„ì¹˜ ê³„ì‚° í›„ ë°˜ì˜    

3. `Hal_interrupt_register_handler()` / `Hal_interrupt_run_handler()`  
- ì¸í„°ëŸ½íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
- `Hal_interrupt_register_handler`: ì¸í„°ëŸ½íŠ¸ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ì— ë“±ë¡í•˜ëŠ” í•¨ìˆ˜  
- `Hal_interrupt_run_handler` : ì¸í„°ëŸ½íŠ¸ í•¸ë“¤ëŸ¬ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜

### 6.2 UART ìž…ë ¥ê³¼ ì¸í„°ëŸ½íŠ¸ ì—°ê²°  
1. Uart.c íŒŒì¼ì—ì„œ Interrupt handler ë¶€ë¶„ê³¼ ì´ˆê¸°í™”ë¶€ë¶„ ì¶”ê°€  
2. main.c ë¶€ë¶„ì—ì„œ UARTì™€ ì¸í„°ëŸ½íŠ¸ ì—°ê²° -> interrupt ì´ˆê¸°í™” í•¨ìˆ˜ ì¶”ê°€


